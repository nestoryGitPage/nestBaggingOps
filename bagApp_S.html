<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>B/Terminal_Sulphur_Bag_2025</title>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
   #unfilterImg {cursor: pointer;width: 28px;height: 28px;
 
}

#unfilterImg:active{transform: translateY(3px);}
     #spn{cursor: pointer ;background-color: transparent;border-radius: 50%;height: 10px;width: 10px;display: inline-block;position: relative;}
  #myTable thead th{position: sticky;top:0}
    #myTable tfoot td{position: sticky;bottom:0}
    #dayTotal, #nightTotal {border:2px solid green;background-color: rgb(51, 8, 8);color: white;}
    #grandTotal{color:yellow;font-style: italic; font-weight: bolder;border: 2px solid green;background-color: rgb(51, 8, 8);border-radius: 20px;}
    #dcscLogo{animation:spin 8s linear infinite;width:70px;height:70px; border-radius: 50%; }
    #homeImg{width:50px;height:50px;cursor: pointer;}
    #homeImg:active{transform: translateY(4px);}
    #homeImg:hover{transform: scale(1.04);}

@keyframes spin{
      from{transform:rotateY(0deg)}  
      to{transform:rotateY(360deg)}
    }
      [printbtn]{border-radius: 20px;height:fit-content ;width: 6em;}
    #dcsttLogo{display: inline-block; width: 50PX; height: 50PX;position: absolute;left: 44em;top: 1.7em;}
   #LogoutBtn:hover, [printbtn]:hover {background-color: grey;color:white} 
   #LogoutBtn:active, [printbtn]:active {transform: translateY(4px);}
    #relodImg:hover{transform: scale(1.3);background-color: rgb(235, 230, 225);}
    #relodImg{cursor: pointer; width: 30PX; height: 30px;}
    .dropdown-menu { max-height: 200px; overflow-y: auto; }
    th { vertical-align: middle; white-space: nowrap; }
    #cc { position: relative; top: px; }
    #tbody1 td { padding: 8px 4px; height: auto; min-height: 35px; vertical-align: middle; text-align: center; white-space: nowrap; overflow: visible; }
  #myTable caption{visibility: hidden;}

  /* Print Styles */
@media print {
   body * {
      visibility: hidden; /* Hide everything */
    }
    #myTable, #myTable * {
      visibility: visible; /* Only show the table */
    }
    #myTable {
      position: absolute;
      left: 3px;
      top: 0;
      margin-top: 20px;
    }
  table tr th:nth-child(10),table tr th:nth-child(9), 
  table tr td:nth-child(10),
  table tr td:nth-child(9) {display: none;} 
    #tableContainer {
        max-height: none !important;
        overflow: visible !important;
        
      /*  margin-top: 0 !important;  */
    }
/*    
    thead th, tfoot td {
        position: static !important;  
    }    */
    .dropdown, .mido, [printbtnTd]{display: none !important;}

    @page{size :A4; margin: 10mm;}

     * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    #myTable caption {
      visibility: visible;
  caption-side: top; /* default, but we reapply it to be safe */
  font-weight: bold;
  text-align: center;
  margin-bottom: 10px;
}

}

.table-dark th {
  background-color: #0f1724; /* row background (example: dark blue/gray) */
  color: #e8eef8;            /* row text color */
}
  </style>
</head>
<body>



<div class="table-responsive" id="cont" style="margin-left: 5%;width:fit-content;">
              <div id="holdTops" style="z-index: 5; position: fixed; top: 0; background-color: white;margin-bottom: 0%;">
  <h5>Sulphur Bagging Operation 2025_<i>B/Terminal</i></h5>
                <div style="display: flex;gap:3em;">
  <div class="d-flex gap-3 mb-0" style="width: fit-content;">
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">Project#</button>
    <ul class="dropdown-menu" id="projectFilter"></ul>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">Date</button>
    <ul class="dropdown-menu" id="dateFilter"></ul>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">Poster</button>
    <ul class="dropdown-menu" id="posterFilter"></ul>
  </div>
  <div class="dropdown"> 
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">week#</button>
    <ul class="dropdown-menu" id="weekNoFilter"></ul>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">month</button>
    <ul class="dropdown-menu" id="monthNoFilter"></ul>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-warning dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">ðŸŸ  NAULI</button>
    <ul class="dropdown-menu" id="orangeFilter"></ul>
  </div>

</div>

<div style=" margin-top:0px; position: relative; bottom: 22px; display: flex; gap: 2em; align-items: center;justify-content: center;">
  <div>
    <img id="unfilterImg" src="imgs/unfilter3.png" alt="unfilter_img"  data-bs-toggle="tooltip" title="Unfilter">
  </div>

  <div>
 <img onclick="location.reload()" id="relodImg" src="imgs/refresh2.png" alt="relodImg" data-bs-toggle="tooltip" title="Refresh">
  </div>
  
  <div>
    <a href="landing.html"> <img id="homeImg" src="imgs/housepng.png" alt="housepng" data-bs-toggle="tooltip" title="Home"> </a>
  </div>

  <div>
<img id="dcscLogo" src="imgs/dcscLogo.png" alt="DCSClogo">
  </div>
  </div>

  </div>

                    
         <div class="mido"  style="margin-bottom: 0px; background-color: rgb(175, 175, 240); display: flex; gap: 5em;position: absolute;top: 4.7em;">
  <input readonly style=" width:fit-content;" type="text" id="posterInput" class="form-control mb-0" placeholder="poster name">
  <input style=" width:fit-content;" type="number" id="projectBox" class="form-control mb-0" placeholder="enter project#">
   <button id="LogoutBtn">Logout</button>

    <span style="position: relative;bottom: -7px;">
  <select onchange="if(this.value){window.location=this.value}" style=" border-radius: 10px;width: 7em; ">
    <option value="">select year..</option>
    <option value="bagApp_S.html">2025</option>
    <option value="bagApp_BT_Sph_2026.html">2026</option>
  </select> </span>
        

      
    
  
  </div>
                     

             </div>
           <div id="tableContainer" style="max-height: 80vh; overflow:scroll;margin-top: 7em;margin-bottom: 0;">
  <table table1 id="myTable" class="table table-dark table-bordered"> 
    <caption>SULPHUR OPERATIONS_2025_<i>B/Terminal</i></caption>
    <thead style="text-align: center">
      <tr>
        <th>SNo</th>
        <th>Date</th>
        <th>Week#</th>
        <th>Month</th>
        <th style="padding-right:0;">project# <span id="spn"></span></th>
        <th>bagsDay</th>
        <th>bagsNight</th>
        <th>poster</th>
        <th>post time</th>
        <th><span id="cc">C/Center</span> <button style="padding-bottom: 0%;padding-top: 0%;" class="btn btn-success ms-3"  data-bs-toggle="modal" data-bs-target="#actionModal" id="add-0"><i class="fa-solid fa-plus"></i></button></th>
      </tr>
    </thead>
    <tbody id="tbody1"></tbody>
    <tfoot style="font-weight: bolder;text-align: center;">
      <td colspan="5" id="totalsRow">TOTALS</td><td id="dayTotal"></td><td id="nightTotal"></td> <td id="grandTotal"></td>
      <td printbtnTd > <button printbtn onclick="window.print()">print</button> </td> 
    </tfoot>
  </table>

             </div>         
</div>

<!-- Modal -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="actionLabel"></h1>
        <button type="button" class="btn btn-danger ms-3" data-bs-toggle="modal" data-bs-target="#actionModal" id="modXButton"> <i class="fa-solid fa-x"></i> </button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="modDate" class="form-label">Date:</label>
          <input type="text" class="form-control order border-primary" id="modDate">
        </div>
        <div class="mb-3">
          <label for="modProjectNo" class="form-label">project no:</label>
          <input type="number" class="form-control order border-primary" id="modProjectNo">
        </div>
        <div class="mb-3">
          <label for="modbagsDay" class="form-label">Bags Day:</label>
          <input type="number" class="form-control order border-primary" id="modbagsDay">
        </div>
        <div class="mb-3">
          <label for="modbagsNight" class="form-label">Bags Night</label>
          <input type="number" class="form-control order border-primary" id="modbagsNight">
        </div>
        <div hidden class="mb-3">
          <label for="modposter" class="form-label">poster:</label>
          <input readonly type="text" class="form-control order border-primary" id="modposter">
        </div>
        <div hidden class="mb-3">
          <label for="modTimer" class="form-label">Time:</label>
          <input readonly type="text" class="form-control order border-primary" id="modTimer">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="actionBtn"></button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="JSobject.js"></script>

<script type="module">
  import { auth, db } from './firebaseS-config.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import { getDatabase, ref, update, onValue, child, get, set, remove, push } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
/**
 onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
      }
    });      **/  
    let autoScroll = true;

    document.getElementById("LogoutBtn").addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    });           

  ///
let projectFilter = document.getElementById('projectFilter');
let dateFilter = document.getElementById('dateFilter');
let posterFilter = document.getElementById('posterFilter');
let weekNoFilter = document.getElementById('weekNoFilter');
let monthNoFilter = document.getElementById('monthNoFilter');
  ////


  let dateList = [];
  let sno = 0;
  let tbody1 = document.getElementById("tbody1");
  let selectedIndex = -1;

  const SelectAllDataRealtime = () => {
    const dbRef = ref(db, "Myset");
    onValue(dbRef, (snapshot) => {
      dateList = [];
      snapshot.forEach(dates => {
        dateList.push({ key: dates.key, ...dates.val() });
      });
      AddAllRecords();
      updateTotals();
      separated(); 
     if (autoScroll) callem();
autoScroll = false;
      checkPrjctN();
    });

    // Event delegation for dblclick on ProjectNo (column 4), bagsDay (column 5) and bagsNight (column 6)
    tbody1.addEventListener('dblclick', (event) => {
      const cell = event.target.closest('td');
      if (!cell) return;

      const cellIndex = cell.cellIndex;  // Use native cellIndex property (more reliable)
      const recordKey = cell.dataset.recordKey;

      // Check if dblclick is on column 4 (ProjectNo)
      if (cellIndex === 4) {  // Column 5 (0-indexed as 4)
        const projectNum = cell.textContent.trim();
        const projectData = projectNo[projectNum];
        
        if (projectData) {
          const tooltipHTML = `
            <strong>Project Details</strong><br/>
            <span>Project #: ${projectNum}</span><br/>
            <span>Vessel: ${projectData.Vessel_name}</span><br/>
            <span>Client: ${projectData.Client}</span><br/>
            <span>Start Date: ${projectData.startDate}</span>
          `;
          
          // Remove any existing tooltip
          const existingTooltip = document.querySelector('.project-tooltip');
          if (existingTooltip) existingTooltip.remove();
          
          // Create tooltip element
          const tooltip = document.createElement('div');
          tooltip.className = 'project-tooltip position-absolute bg-dark text-white p-3 rounded';
          tooltip.innerHTML = tooltipHTML;
          tooltip.style.zIndex = '9999';
          tooltip.style.maxWidth = '300px';
          tooltip.style.fontSize = '0.85rem';
          
          document.body.appendChild(tooltip);
          
          // Position tooltip near the cell
          const rect = cell.getBoundingClientRect();
          tooltip.style.top = (rect.top + window.scrollY - tooltip.offsetHeight - 10) + 'px';
          tooltip.style.left = (rect.left + window.scrollX) + 'px';
          
          // Auto-remove tooltip after 8 seconds
          setTimeout(() => tooltip.remove(), 8000);
        } else {
          // Show alert if project data not found
          alert(`Project #${projectNum} details not found in JSobject.js`);
        }
      } else if (cellIndex === 5) {  // Column 6 (0-indexed as 5)
        const newColor = (cell.style.backgroundColor === 'orange') ? '' : 'orange';
        cell.style.backgroundColor = newColor;
        if (recordKey) {
          update(ref(db, 'Myset/' + recordKey), { bagsDayColor: newColor }).catch(console.error);
        }
      } else if (cellIndex === 6) {  // Column 7 (0-indexed as 6)
        const newColor = (cell.style.backgroundColor === 'orange') ? '' : 'orange';
        cell.style.backgroundColor = newColor;
        if (recordKey) {
          update(ref(db, 'Myset/' + recordKey), { bagsNightColor: newColor }).catch(console.error);
        }
      }
    }, { once: false });

    
  }  /////

  const calculateCustomWeekAndMonth = (dateStr) => {
  const dateParts = dateStr.split('-');
  const day = parseInt(dateParts[0], 10);
  const month = parseInt(dateParts[1], 10) - 1;
  const year = parseInt(dateParts[2], 10);

  const currentDate = new Date(year, month, day);
  const startDate = new Date(2025, 5, 6); // 06 June 2025

  const firstWeekNumber = 24;
  const diffInMs = currentDate - startDate;
  const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
  const weekNumber = firstWeekNumber + Math.floor(diffInDays / 7);

  const monthName = currentDate.toLocaleString('default', { month: 'long' });

  return { week: weekNumber, month: monthName };
};

////////

  const AddSingleRecord = (dater, ProjectNo, bagsDay, bagsNight, poster, timer, recordKey, bagsDayColor, bagsNightColor) => {
    let trow = document.createElement('tr');

// Calculate Week# and Month
  let weekInfo = calculateCustomWeekAndMonth(dater);


    let td1 = document.createElement('td');
    let td2 = document.createElement('td');
    let td3 = document.createElement('td');
    let td4 = document.createElement('td');
    let td5 = document.createElement('td');
    let td6 = document.createElement('td');
    let td7 = document.createElement('td');
    let td8 = document.createElement('td');
    let td9 = document.createElement('td');
    let td10 = document.createElement('td');

    td1.textContent = ++sno;
    td2.textContent = dater;
    td3.textContent = weekInfo.week;
    td4.textContent = weekInfo.month;
    td5.textContent = ProjectNo;
    td6.textContent = parseInt(bagsDay) || 0;
    td7.textContent = parseInt(bagsNight) || 0;
    td8.textContent = poster;
    td9.textContent = timer;

    let EditButton = document.createElement("button");
    let DelButton = document.createElement("button");

    EditButton.id = 'edit-' + sno;
    EditButton.className = 'btn btn-primary me-2';
    EditButton.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
    EditButton.setAttribute('data-bs-toggle', "modal");
    EditButton.setAttribute('data-bs-target', "#actionModal");
    EditButton.addEventListener('click', LoadModal);

    DelButton.id = 'del-' + sno;
    DelButton.className = 'btn btn-danger me-2';
    DelButton.innerHTML = '<i class="fa-solid fa-trash"></i>';
    DelButton.setAttribute('data-bs-toggle', "modal");
    DelButton.setAttribute('data-bs-target', "#actionModal");
    DelButton.addEventListener('click', LoadModal);

    td10.append(EditButton, DelButton);
    // apply initial colors if present
    if (bagsDayColor) td6.style.backgroundColor = bagsDayColor;
    if (bagsNightColor) td7.style.backgroundColor = bagsNightColor;

    // Store recordKey on the cell for later use in event delegation
    td6.dataset.recordKey = recordKey || '';
    td7.dataset.recordKey = recordKey || '';
    
    trow.append(td1, td2, td3, td4, td5, td6, td7, td8, td9, td10);
    tbody1.appendChild(trow);
  }
  //

  function filterRows() {
    const tableRows = document.querySelectorAll('#tbody1 tr');
  const selectedProjects = Array.from(projectFilter.querySelectorAll('input:checked')).map(cb => cb.value);
  const selectedDates = Array.from(dateFilter.querySelectorAll('input:checked')).map(cb => cb.value);
  const selectedPosters = Array.from(posterFilter.querySelectorAll('input:checked')).map(cb => cb.value);
  const selectedweekNo = Array.from(weekNoFilter.querySelectorAll('input:checked')).map(cb => cb.value);
  const selectedmonthNo = Array.from(monthNoFilter.querySelectorAll('input:checked')).map(cb => cb.value);
  const selectedOrange = Array.from(orangeFilter.querySelectorAll('input:checked')).map(cb => cb.value);

  tableRows.forEach(row => {
    const projectText = row.cells[4].textContent;
    const dateText = row.cells[1].textContent;
    const posterText = row.cells[7].textContent;
    const weekNoText = row.cells[2].textContent;
    const monthNoText = row.cells[3].textContent;
    
    // Check if row has orange cells in bagsDay (column 5) or bagsNight (column 6)
    const bagsDay = row.cells[5];
    const bagsNight = row.cells[6];
    const hasOrange = bagsDay.style.backgroundColor === 'orange' || bagsNight.style.backgroundColor === 'orange';

    const projectMatch = selectedProjects.length === 0 || selectedProjects.includes(projectText);
    const dateMatch = selectedDates.length === 0 || selectedDates.includes(dateText);
    const posterMatch = selectedPosters.length === 0 || selectedPosters.includes(posterText);
    const weekNoMatch = selectedweekNo.length === 0 || selectedweekNo.includes(weekNoText);
    const monthNoMatch = selectedmonthNo.length === 0 || selectedmonthNo.includes(monthNoText);
    const orangeMatch = selectedOrange.length === 0 || (selectedOrange.includes('with-orange') && hasOrange) || (selectedOrange.includes('without-orange') && !hasOrange);

    if (projectMatch && dateMatch && posterMatch && weekNoMatch && monthNoMatch && orangeMatch) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });

 updateTotals();
 
}
///

  const AddAllRecords = () => {
    sno = 0;
    tbody1.innerText = "";
    dateList.forEach(dates => {
      AddSingleRecord(
        dates.dater,
        dates.ProjectNo,
        dates.bagsDay,
        dates.bagsNight,
        dates.poster,
        dates.timer,
        dates.key,
        dates.bagsDayColor || '',
        dates.bagsNightColor || ''
      );
    });

    const tableRows = document.querySelectorAll('#tbody1 tr');



// Helper to get unique column values
function getUniqueValues(colIndex) {
  const values = new Set();
  tableRows.forEach(row => {
    values.add(row.cells[colIndex].textContent);
  });
  return Array.from(values);
}

// Generate checkboxes for a filter dropdown with a search box
function createCheckboxes(values, container) {
  container.innerHTML = "";

  // Search input
  const searchLi = document.createElement('li');
  const searchInput = document.createElement('input');
  searchInput.type = 'text';
  searchInput.className = 'form-control form-control-sm m-2';
  searchInput.placeholder = 'Search...';
  // prevent dropdown from closing when interacting with the search input
  searchInput.addEventListener('click', (e) => e.stopPropagation());
  searchInput.addEventListener('keydown', (e) => e.stopPropagation());
  searchLi.appendChild(searchInput);
  container.appendChild(searchLi);

  // Select All / Deselect All buttons
  const buttonContainerLi = document.createElement('li');
  buttonContainerLi.style.display = 'flex';
  buttonContainerLi.style.gap = '0.5rem';
  buttonContainerLi.style.padding = '0.5rem 0.5rem';

  const selectAllBtn = document.createElement('button');
  selectAllBtn.className = 'btn btn-sm btn-outline-primary flex-grow-1';
  selectAllBtn.style.fontSize = '0.75rem';
  selectAllBtn.style.padding = '0.25rem 0.5rem';
  selectAllBtn.textContent = 'All';
  selectAllBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => {
      if (cb.closest('li').style.display !== 'none') {
        cb.checked = true;
      }
    });
    filterRows();
  });
  buttonContainerLi.appendChild(selectAllBtn);

  const deselectAllBtn = document.createElement('button');
  deselectAllBtn.className = 'btn btn-sm btn-outline-danger flex-grow-1';
  deselectAllBtn.style.fontSize = '0.75rem';
  deselectAllBtn.style.padding = '0.25rem 0.5rem';
  deselectAllBtn.textContent = 'None';
  deselectAllBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => {
      if (cb.closest('li').style.display !== 'none') {
        cb.checked = false;
      }
    });
    filterRows();
  });
  buttonContainerLi.appendChild(deselectAllBtn);
  container.appendChild(buttonContainerLi);

  // Divider
  const dividerLi = document.createElement('li');
  dividerLi.innerHTML = '<hr class="dropdown-divider m-1">';
  container.appendChild(dividerLi);

  values.forEach(value => {
    const li = document.createElement('li');
    const label = document.createElement('label');
    label.classList.add('dropdown-item');

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = value;
    checkbox.addEventListener('change', filterRows);

    label.appendChild(checkbox);
    label.append(' ' + value);
    li.appendChild(label);
    container.appendChild(li);
  });

  // Filter function for search
  searchInput.addEventListener('input', () => {
    const filter = searchInput.value.trim().toLowerCase();
    const items = container.querySelectorAll('li');
    items.forEach((item, idx) => {
      // skip the search input li (idx === 0), select all (idx === 1), deselect all (idx === 2), and divider (idx === 3)
      if (idx <= 3) return;
      const label = item.querySelector('label');
      const text = label ? label.textContent.trim().toLowerCase() : '';
      item.style.display = text.includes(filter) ? '' : 'none';
    });
  });

  // Prevent dropdowns from closing when interacting with checkboxes
  container.addEventListener('click', (e) => { e.stopPropagation(); });
}

// Initialize filters
createCheckboxes(getUniqueValues(4), projectFilter); // Project#
createCheckboxes(getUniqueValues(1), dateFilter);  // Date
createCheckboxes(getUniqueValues(7), posterFilter); // Poster
createCheckboxes(getUniqueValues(2), weekNoFilter); // weekNo
createCheckboxes(getUniqueValues(3), monthNoFilter); // monthNo
createCheckboxes(['with-orange', 'without-orange'], orangeFilter); // Orange filter
//
document.getElementById("unfilterImg").addEventListener("click", function() {
  // Uncheck all filter checkboxes
  document.querySelectorAll(
    "#projectFilter input[type=checkbox], " +
    "#dateFilter input[type=checkbox], " +
    "#posterFilter input[type=checkbox], " +
    "#weekNoFilter input[type=checkbox], " +
    "#monthNoFilter input[type=checkbox], " +
    "#orangeFilter input[type=checkbox]"
  ).forEach(cb => cb.checked = false); 
  // Show all rows by calling the filter function
 // const tableRows = document.querySelectorAll('#tbody1 tr');
 //tableRows.forEach(row => row.style.display = '');

  filterRows();
  });

    
  }

  let modXButton = document.getElementById("modXButton");
  let actionLabel = document.getElementById("actionLabel");
  let actionBtn = document.getElementById("actionBtn");
  let addBtn = document.getElementById("add-0");
  let modDate = document.getElementById("modDate");
  let modProjectNo = document.getElementById("modProjectNo");
  let modbagsDay = document.getElementById("modbagsDay");
  let modbagsNight = document.getElementById("modbagsNight");
  let modposter = document.getElementById("modposter");
  let modTimer = document.getElementById("modTimer");

  let posterName = "";

  const LoadModal = (event) => {
    const targetId = (event.target.id.length > 1) ? event.target.id : event.target.parentElement.id;
    const string = targetId.split('-');
    const mode = string[0];
    selectedIndex = string[1] - 1;


actionBtn.replaceWith(actionBtn.cloneNode(true));
    actionBtn = document.getElementById("actionBtn");
    actionBtn.disabled = false;

    if (mode === 'add') {
      actionBtn.className = 'btn btn-lg btn-success';
      actionLabel.innerText = 'Add New Record';
      actionBtn.innerText = 'Add';
      actionBtn.addEventListener('click', AddData);

      modDate.value = "";
      modProjectNo.value = projectBox.value || 0;
      modbagsDay.value = "";
      modbagsNight.value = "";
      modposter.value = posterInput.value;
      modTimer.value = "";
    } else if (mode === 'edit') {
      // Check if user is authorized to edit
      const allowedPosters = ["A Mbaya", "N Mahunja", "J Mweta", "F Martin", "k NEBU"];
      if (!allowedPosters.includes(posterInput.value)) {
        alert("You are not authorized to edit records");
        modXButton.click();
        return;
      }

      setInterval(() => {
        const now = new Date();
        const options = { month: 'long' };
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const month = now.toLocaleString('en-US', options);
        const year = String(now.getFullYear()).slice(-2);
        modTimer.value = hours + ":" + minutes + ", " + day + " " + month + " " + year;
      }, 1000);

      actionBtn.className = 'btn btn-lg btn-primary';
      actionLabel.innerText = 'Edit Record';
      actionBtn.innerText = 'Update';
      actionBtn.addEventListener("click", UpdData);

      modDate.value = dateList[selectedIndex].dater;
      modProjectNo.value = projectBox.value || 0;
      modbagsDay.value = dateList[selectedIndex].bagsDay;
      modbagsNight.value = dateList[selectedIndex].bagsNight;
      modposter.value = posterInput.value;
      modTimer.value = dateList[selectedIndex].timer;
    } else if (mode === 'del') {
      actionBtn.className = 'btn btn-lg btn-danger';
      actionLabel.innerText = 'Delete This Record';
      actionBtn.innerText = 'Confirm Delete';
      actionBtn.addEventListener("click", DelData);

      modDate.value = dateList[selectedIndex].dater;
      modProjectNo.value = dateList[selectedIndex].ProjectNo;
      modbagsDay.value = dateList[selectedIndex].bagsDay;
      modbagsNight.value = dateList[selectedIndex].bagsNight;
      modposter.value = posterInput.value;
      modTimer.value = dateList[selectedIndex].timer;
    }
  }

  const AddData = () => {
    autoScroll = true;
  actionBtn.disabled = true;

  const now = new Date();
  const options = { month: 'long' };
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const month = now.toLocaleString('en-US', options);
  const year = String(now.getFullYear()).slice(-2);

  const curentTime = hours + ":" + minutes + ", " + day + " " + month + " " + year;

  const dbRef = ref(db, 'Myset');
  push(dbRef, {
    dater: modDate.value,
    ProjectNo: Number(modProjectNo.value),
    bagsDay: Number(modbagsDay.value),
    bagsNight: Number(modbagsNight.value),
    poster: modposter.value,
    timer: curentTime,
    bagsDayColor: '',
    bagsNightColor: ''
  }).then(() => {
    modXButton.click();
  });
};
  const UpdData = () => {
  actionBtn.disabled = true;

  const recordKey = dateList[selectedIndex].key;

  update(ref(db, 'Myset/' + recordKey), {
    dater: modDate.value,
    ProjectNo: Number(modProjectNo.value),
    bagsDay: Number(modbagsDay.value),
    bagsNight: Number(modbagsNight.value),
    poster: modposter.value,
    timer: modTimer.value,
    bagsDayColor: dateList[selectedIndex].bagsDayColor || '',
    bagsNightColor: dateList[selectedIndex].bagsNightColor || ''
  }).then(() => {
    modXButton.click();
  });
};
  const DelData = () => {
    if (posterInput.value !== "N Mahunja") {
        alert("You are not Admin, Can't Delete Data");
        return;
    }

    actionBtn.disabled = true;

    const recordKey = dateList[selectedIndex].key;

    remove(ref(db, 'Myset/' + recordKey)).then(() => {
        modXButton.click();
    });
};
///


  addBtn.addEventListener('click', LoadModal);
      
    window.onload = () => { 
     
  const posterInput = document.getElementById("posterInput");
        
  function askForId() {
    const posterId = prompt("Enter your passcode:");

    if (posterId) {
      const idRef = ref(db, 'UserIds/' + posterId);

      get(idRef).then((snapshot) => {
        if (snapshot.exists()) {
          posterInput.value = snapshot.val();
          SelectAllDataRealtime();
         // updateTotals(); 
          
          // Enable add button only for authorized users
const allowedPosters = ["A Mbaya", "N Mahunja", "J Mweta", "F Martin", "k NEBU"];
const isAuthorized = allowedPosters.includes(posterInput.value);
document.getElementById("add-0").disabled = !isAuthorized;

// Disable all edit buttons if not authorized
if (!isAuthorized) {
  document.querySelectorAll('[id^="edit-"]').forEach(btn => btn.disabled = true);
}
        } else {
          alert("user not recognized. Try again.");
          askForId();
        }
      }).catch((error) => {
        console.error("Error fetching ID:", error);
      });
    } else {
      askForId();
    }
  }   

  askForId();
};           

  flatpickr("#modDate", { dateFormat: "d-m-Y" });

  function updateTotals() {
  const table = document.getElementById("myTable");
  const rows = table.querySelectorAll("tbody tr");

  let daySum = 0;
  let nightSum = 0;

  rows.forEach(row => {
    if (row.id === "totalsRow") return;

    // Skip rows that are hidden by filtering
    if (row.style.display === "none") return;

    const cells = row.querySelectorAll("td");
    const dayVal = parseInt(cells[5].textContent.replace(/,/g, "")) || 0;
    const nightVal = parseInt(cells[6].textContent.replace(/,/g, "")) || 0;

    daySum += dayVal;
    nightSum += nightVal;
  });

  document.getElementById("dayTotal").textContent = daySum.toLocaleString();
  document.getElementById("nightTotal").textContent = nightSum.toLocaleString();
  document.getElementById("grandTotal").textContent = (parseInt(daySum) + parseInt(nightSum)).toLocaleString();
}   
////
const separated = () => {
  const rows = document.querySelectorAll("#myTable tbody tr");

  rows.forEach(row => {
    const td6 = row.querySelector("td:nth-child(6)");
    const td7 = row.querySelector("td:nth-child(7)");

    if (td6) {
      const num6 = parseFloat(td6.textContent.replace(/,/g, ''));
      if (!isNaN(num6)) {
        td6.textContent = num6.toLocaleString();
      }
    }

    if (td7) {
      const num7 = parseFloat(td7.textContent.replace(/,/g, ''));
      if (!isNaN(num7)) {
        td7.textContent = num7.toLocaleString();
      }
    }
  });
}

////
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
////
    
   

</script>
<script>

  function callem(){ 
 let tbody1 = document.getElementById("tbody1");
  let lastRow = tbody1.lastElementChild;

  if (lastRow) {
    lastRow.scrollIntoView({ behavior: "smooth" });
  }   
    
  }

  ////

  
</script>
<script>
function checkPrjctN(){
  const spn = document.getElementById("spn");
  let foundInvalid = false;
  document.querySelectorAll("#myTable tbody tr").forEach((row) => {
    if (row.cells[4] && row.cells[4].innerText.trim().length !== 8) {
      row.cells[4].style.backgroundColor = "red";
      row.cells[4].style.border = "yellow";
      foundInvalid = true;
    } else if (row.cells[4]) {
      row.cells[4].style.backgroundColor = "";
      row.cells[4].style.border = "";
    }
  });
  spn.style.backgroundColor = foundInvalid ? "red" : "transparent";
}

let invalidProjectRows = [];
let invalidProjectIndex = 0;

document.getElementById("spn").addEventListener("click", function () {
  // Collect all invalid rows each time in case the table changes
  const rows = document.querySelectorAll("#myTable tbody tr");
  invalidProjectRows = [];
  rows.forEach(row => {
    if (row.cells[4] && row.cells[4].innerText.trim().length !== 8) {
      invalidProjectRows.push(row);
    }
  });

  if (invalidProjectRows.length === 0) return;

  // Scroll to the current invalid row
  invalidProjectRows[invalidProjectIndex].scrollIntoView({ behavior: "smooth", block: "center" });

  // Optionally, you can highlight the row for clarity
  invalidProjectRows.forEach((row, idx) => {
    row.style.outline = idx === invalidProjectIndex ? "2px solid yellow" : "";
  });

  // Move to next index for next click
  invalidProjectIndex = (invalidProjectIndex + 1) % invalidProjectRows.length;
});

// Reset index when table is updated (optional, but recommended)
function resetInvalidProjectIndex() {
  invalidProjectIndex = 0;
}

///



</script>

</body>
</html>
