
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sulphur Bagging Ops_2025</title>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
   
    #myTable thead th{position: sticky;top:0}
    #myTable tfoot td{position: sticky;bottom:0}
    #dayTotal, #nightTotal {border:2px solid green;background-color: grey;color: white;}
    #grandTotal{color:yellow;font-style: italic; font-weight: bolder;}
    #dcscLogo{animation:spin 8s linear infinite;position: absolute; width:70px;height:70px; border-radius: 50%;left: 44em;top: 1em; }
    #homeImg{position: absolute; width:60px;height:60px;left: 49em;top: 1em;cursor: pointer;}
    #homeImg:active{transform: translateY(4px);}
    #homeImg:hover{transform: scale(1.04);}
@keyframes spin{
      from{transform:rotateY(0deg)}  
      to{transform:rotateY(360deg)}
    }
      
    #dcsttLogo{display: inline-block; width: 50PX; height: 50PX;position: absolute;left: 44em;top: 1.7em;}
   #LogoutBtn:hover, [printbtn]:hover {background-color: grey;color:white} 
   #LogoutBtn:active, [printbtn]:active {transform: translateY(4px);}
    #relodImg:hover{transform: scale(1.3);background-color: rgb(235, 230, 225);}
    #relodImg{cursor: pointer; width: 30PX; height: 30PX;position: relative;right: 4em;bottom: 3.1em;}
    .dropdown-menu { max-height: 200px; overflow-y: auto; }
    th { vertical-align: middle; }
    #cc { position: relative; top: px; }
    #tbody1 td { padding-top: 0%; padding-bottom: 0%; height: fit-content; vertical-align: middle; text-align: center; }
  
  /* Print Styles */
@media print {
    #tableContainer {
        max-height: none !important;
        overflow: visible !important;
      /*  margin-top: 0 !important;  */
    }

    thead th, tfoot td {
        position: static !important;
    }
    .dropdown, .mido, [printbtn]{display: none !important;}

    @page{size :A4; margin: 10mm;}

     * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
}
  </style>
</head>
<body>



<div class="table-responsive" id="cont" style="margin-left: 5%;width:fit-content;">
              <div id="holdTops" style="z-index: 5; position: fixed; top: 0; background-color: white;margin-bottom: 0%;">
  <h5>Sulphur Bagging Operation 2025</h5>
<div class="d-flex gap-3 mb-2" style="width: fit-content;">
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Project#</button>
    <ul class="dropdown-menu" id="projectFilter"></ul>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Date</button>
    <ul class="dropdown-menu" id="dateFilter"></ul>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Poster</button>
    <ul class="dropdown-menu" id="posterFilter"></ul>
  </div>
  <div class="dropdown"> 
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">week#</button>
    <ul class="dropdown-menu" id="weekNoFilter"></ul>
  </div>
  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">month</button>
    <ul class="dropdown-menu" id="monthNoFilter"></ul>
  </div>
</div>

                    
        <div class="mido"  style="display: flex; gap: 5em;">
  <input readonly style=" width:fit-content;" type="text" id="posterInput" class="form-control mb-0" placeholder="poster name">
  <input style=" width:fit-content;" type="number" id="projectBox" class="form-control mb-0" placeholder="enter project#">
   <button id="LogoutBtn">Logout</button>
        
  <img onclick="location.reload()" id="relodImg" src="imgs/refresh2.png" alt="relodImg" data-bs-toggle="tooltip" title="Refresh">
   <img id="dcscLogo" src="imgs/dcscLogo.png" alt="DCSClogo">  
   <a href="landing.html"> <img id="homeImg" src="imgs/housepng.png" alt="housepng"> </a>
    
  
  </div>
                     

             </div>
           <div id="tableContainer" style="max-height: 80vh; overflow:scroll;margin-top: 7em;margin-bottom: 0;">
  <table table1 id="myTable" class="table table-dark "> 
    <thead  style="text-align: center">
      <tr>
        <th>SNo</th>
        <th>Date</th>
        <th>WK#</th>
        <th>MNTH</th>
        <th>project#</th>
        <th>bagsDay</th>
        <th>bagsNight</th>
        <th>poster</th>
        <th>post time</th>
        <th><span id="cc">C/Center</span> <button style="padding-bottom: 0%;padding-top: 0%;" class="btn btn-success ms-3"  data-bs-toggle="modal" data-bs-target="#actionModal" id="add-0"><i class="fa-solid fa-plus"></i></button></th>
      </tr>
    </thead>
    <tbody id="tbody1"></tbody>
    <tfoot style="font-weight: bolder;text-align: center;">
      <td colspan="5" id="totalsRow">TOTALS</td><td id="dayTotal"></td><td id="nightTotal"></td> <td id="grandTotal"></td>
      <td> <button printbtn onclick="window.print()">print</button> </td>
    </tfoot>
  </table>
             </div>         
</div>

<!-- Modal -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="actionLabel"></h1>
        <button type="button" class="btn btn-danger ms-3" data-bs-toggle="modal" data-bs-target="#actionModal" id="modXButton"> <i class="fa-solid fa-x"></i> </button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="modDate" class="form-label">Date:</label>
          <input type="text" class="form-control order border-primary" id="modDate">
        </div>
        <div class="mb-3">
          <label for="modProjectNo" class="form-label">project no:</label>
          <input type="number" class="form-control order border-primary" id="modProjectNo">
        </div>
        <div class="mb-3">
          <label for="modbagsDay" class="form-label">Bags Day:</label>
          <input type="number" class="form-control order border-primary" id="modbagsDay">
        </div>
        <div class="mb-3">
          <label for="modbagsNight" class="form-label">Bags Night</label>
          <input type="number" class="form-control order border-primary" id="modbagsNight">
        </div>
        <div hidden class="mb-3">
          <label for="modposter" class="form-label">poster:</label>
          <input readonly type="text" class="form-control order border-primary" id="modposter">
        </div>
        <div hidden class="mb-3">
          <label for="modTimer" class="form-label">Time:</label>
          <input readonly type="text" class="form-control order border-primary" id="modTimer">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="actionBtn"></button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script type="module">
  import { auth, db } from './firebaseS-config.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import { getDatabase, ref, update, onValue, child, get, set, remove, push } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

 onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
      }
    });

    document.getElementById("LogoutBtn").addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    });

  ///


  let dateList = [];
  let sno = 0;
  let tbody1 = document.getElementById("tbody1");
  let selectedIndex = -1;

  const SelectAllDataRealtime = () => {
    const dbRef = ref(db, "Myset");
    onValue(dbRef, (snapshot) => {
      dateList = [];
      snapshot.forEach(dates => {
        dateList.push({ key: dates.key, ...dates.val() });
      });
      AddAllRecords();
      updateTotals();
      separated(); 
    });

    
  }
  /////

  const calculateCustomWeekAndMonth = (dateStr) => {
  const dateParts = dateStr.split('-');
  const day = parseInt(dateParts[0], 10);
  const month = parseInt(dateParts[1], 10) - 1;
  const year = parseInt(dateParts[2], 10);

  const currentDate = new Date(year, month, day);
  const startDate = new Date(2025, 5, 6); // 06 June 2025

  const firstWeekNumber = 24;
  const diffInMs = currentDate - startDate;
  const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
  const weekNumber = firstWeekNumber + Math.floor(diffInDays / 7);

  const monthName = currentDate.toLocaleString('default', { month: 'long' });

  return { week: weekNumber, month: monthName };
};

////////

  const AddSingleRecord = (dater, ProjectNo, bagsDay, bagsNight, poster, timer) => {
    let trow = document.createElement('tr');

// Calculate Week# and Month
  let weekInfo = calculateCustomWeekAndMonth(dater);


    let td1 = document.createElement('td');
    let td2 = document.createElement('td');
    let td3 = document.createElement('td');
    let td4 = document.createElement('td');
    let td5 = document.createElement('td');
    let td6 = document.createElement('td');
    let td7 = document.createElement('td');
    let td8 = document.createElement('td');
    let td9 = document.createElement('td');
    let td10 = document.createElement('td');

    td1.textContent = ++sno;
    td2.textContent = dater;
    td3.textContent = weekInfo.week;
    td4.textContent = weekInfo.month;
    td5.textContent = ProjectNo;
    td6.textContent = parseInt(bagsDay) || 0;
    td7.textContent = parseInt(bagsNight) || 0;
    td8.textContent = poster;
    td9.textContent = timer;

    let EditButton = document.createElement("button");
    let DelButton = document.createElement("button");

    EditButton.id = 'edit-' + sno;
    EditButton.className = 'btn btn-primary me-2';
    EditButton.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
    EditButton.setAttribute('data-bs-toggle', "modal");
    EditButton.setAttribute('data-bs-target', "#actionModal");
    EditButton.addEventListener('click', LoadModal);

    DelButton.id = 'del-' + sno;
    DelButton.className = 'btn btn-danger me-2';
    DelButton.innerHTML = '<i class="fa-solid fa-trash"></i>';
    DelButton.setAttribute('data-bs-toggle', "modal");
    DelButton.setAttribute('data-bs-target', "#actionModal");
    DelButton.addEventListener('click', LoadModal);

    td10.append(EditButton, DelButton);
    trow.append(td1, td2, td3, td4, td5, td6, td7, td8, td9, td10);
    tbody1.appendChild(trow);
  }

  const AddAllRecords = () => {
    sno = 0;
    tbody1.innerText = "";
    dateList.forEach(dates => {
      AddSingleRecord(dates.dater, dates.ProjectNo, dates.bagsDay, dates.bagsNight, dates.poster, dates.timer);
    });

    const tableRows = document.querySelectorAll('#tbody1 tr');

const projectFilter = document.getElementById('projectFilter');
const dateFilter = document.getElementById('dateFilter');
const posterFilter = document.getElementById('posterFilter');
const weekNoFilter = document.getElementById('weekNoFilter');
const monthNoFilter = document.getElementById('monthNoFilter');

// Helper to get unique column values
function getUniqueValues(colIndex) {
  const values = new Set();
  tableRows.forEach(row => {
    values.add(row.cells[colIndex].textContent);
  });
  return Array.from(values);
}

// Generate checkboxes for a filter dropdown
function createCheckboxes(values, container) {
  container.innerHTML="";
  values.forEach(value => {
    const li = document.createElement('li');
    const label = document.createElement('label');
    label.classList.add('dropdown-item');

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = value;
    checkbox.addEventListener('change', filterRows);

    label.appendChild(checkbox);
    label.append(' ' + value);
    li.appendChild(label);
    container.appendChild(li);
  });
}

// Initialize filters
createCheckboxes(getUniqueValues(4), projectFilter); // Project#
createCheckboxes(getUniqueValues(1), dateFilter);  // Date
createCheckboxes(getUniqueValues(7), posterFilter); // Poster
createCheckboxes(getUniqueValues(2), weekNoFilter); // weekNo
createCheckboxes(getUniqueValues(3), monthNoFilter); // monthNo

function filterRows() {
  const selectedProjects = Array.from(projectFilter.querySelectorAll('input:checked')).map(cb => cb.value);
  const selectedDates = Array.from(dateFilter.querySelectorAll('input:checked')).map(cb => cb.value);
  const selectedPosters = Array.from(posterFilter.querySelectorAll('input:checked')).map(cb => cb.value);
  const selectedweekNo = Array.from(weekNoFilter.querySelectorAll('input:checked')).map(cb => cb.value);
  const selectedmonthNo = Array.from(monthNoFilter.querySelectorAll('input:checked')).map(cb => cb.value);

  tableRows.forEach(row => {
    const projectText = row.cells[4].textContent;
    const dateText = row.cells[1].textContent;
    const posterText = row.cells[7].textContent;
    const weekNoText = row.cells[2].textContent;
    const monthNoText = row.cells[3].textContent;
    

    const projectMatch = selectedProjects.length === 0 || selectedProjects.includes(projectText);
    const dateMatch = selectedDates.length === 0 || selectedDates.includes(dateText);
    const posterMatch = selectedPosters.length === 0 || selectedPosters.includes(posterText);
    const weekNoMatch = selectedweekNo.length === 0 || selectedweekNo.includes(weekNoText);
    const monthNoMatch = selectedmonthNo.length === 0 || selectedmonthNo.includes(monthNoText);

    if (projectMatch && dateMatch && posterMatch && weekNoMatch && monthNoMatch) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });

 updateTotals();
}
    
  }

  let modXButton = document.getElementById("modXButton");
  let actionLabel = document.getElementById("actionLabel");
  let actionBtn = document.getElementById("actionBtn");
  let addBtn = document.getElementById("add-0");
  let modDate = document.getElementById("modDate");
  let modProjectNo = document.getElementById("modProjectNo");
  let modbagsDay = document.getElementById("modbagsDay");
  let modbagsNight = document.getElementById("modbagsNight");
  let modposter = document.getElementById("modposter");
  let modTimer = document.getElementById("modTimer");

  let posterName = "";

  const LoadModal = (event) => {
    const targetId = (event.target.id.length > 1) ? event.target.id : event.target.parentElement.id;
    const string = targetId.split('-');
    const mode = string[0];
    selectedIndex = string[1] - 1;


actionBtn.replaceWith(actionBtn.cloneNode(true));
    actionBtn = document.getElementById("actionBtn");
    actionBtn.disabled = false;

    if (mode === 'add') {
      actionBtn.className = 'btn btn-lg btn-success';
      actionLabel.innerText = 'Add New Record';
      actionBtn.innerText = 'Add';
      actionBtn.addEventListener('click', AddData);

      modDate.value = "";
      modProjectNo.value = projectBox.value || 0;
      modbagsDay.value = "";
      modbagsNight.value = "";
      modposter.value = posterInput.value;
      modTimer.value = "";
    } else if (mode === 'edit') {
      setInterval(() => {
        const now = new Date();
        const options = { month: 'long' };
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const month = now.toLocaleString('en-US', options);
        const year = String(now.getFullYear()).slice(-2);
        modTimer.value = hours + ":" + minutes + ", " + day + " " + month + " " + year;
      }, 1000);

      actionBtn.className = 'btn btn-lg btn-primary';
      actionLabel.innerText = 'Edit Record';
      actionBtn.innerText = 'Update';
      actionBtn.addEventListener("click", UpdData);

      modDate.value = dateList[selectedIndex].dater;
      modProjectNo.value = projectBox.value || 0;
      modbagsDay.value = dateList[selectedIndex].bagsDay;
      modbagsNight.value = dateList[selectedIndex].bagsNight;
      modposter.value = posterInput.value;
      modTimer.value = dateList[selectedIndex].timer;
    } else if (mode === 'del') {
      actionBtn.className = 'btn btn-lg btn-danger';
      actionLabel.innerText = 'Delete This Record';
      actionBtn.innerText = 'Confirm Delete';
      actionBtn.addEventListener("click", DelData);

      modDate.value = dateList[selectedIndex].dater;
      modProjectNo.value = dateList[selectedIndex].ProjectNo;
      modbagsDay.value = dateList[selectedIndex].bagsDay;
      modbagsNight.value = dateList[selectedIndex].bagsNight;
      modposter.value = posterInput.value;
      modTimer.value = dateList[selectedIndex].timer;
    }
  }

  const AddData = () => {
  actionBtn.disabled = true;

  const now = new Date();
  const options = { month: 'long' };
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const month = now.toLocaleString('en-US', options);
  const year = String(now.getFullYear()).slice(-2);

  const curentTime = hours + ":" + minutes + ", " + day + " " + month + " " + year;

  const dbRef = ref(db, 'Myset');
  push(dbRef, {
    dater: modDate.value,
    ProjectNo: Number(modProjectNo.value),
    bagsDay: Number(modbagsDay.value),
    bagsNight: Number(modbagsNight.value),
    poster: modposter.value,
    timer: curentTime
  }).then(() => {
    modXButton.click();
  });
};
  const UpdData = () => {
  actionBtn.disabled = true;

  const recordKey = dateList[selectedIndex].key;

  set(ref(db, 'Myset/' + recordKey), {
    dater: modDate.value,
    ProjectNo: Number(modProjectNo.value),
    bagsDay: Number(modbagsDay.value),
    bagsNight: Number(modbagsNight.value),
    poster: modposter.value,
    timer: modTimer.value
  }).then(() => {
    modXButton.click();
  });
};
  const DelData = () => {
    if (posterInput.value !== "N Mahunja") {
        alert("You are not Admin, Can't Delete Data");
        return;
    }

    actionBtn.disabled = true;

    const recordKey = dateList[selectedIndex].key;

    remove(ref(db, 'Myset/' + recordKey)).then(() => {
        modXButton.click();
    });
};

  addBtn.addEventListener('click', LoadModal);
      
    window.onload = () => { 
     
  const posterInput = document.getElementById("posterInput");
        
  function askForId() {
    const posterId = prompt("Enter your passcode:");

    if (posterId) {
      const idRef = ref(db, 'UserIds/' + posterId);

      get(idRef).then((snapshot) => {
        if (snapshot.exists()) {
          posterInput.value = snapshot.val();
          SelectAllDataRealtime();
          updateTotals();
        } else {
          alert("user not recognized. Try again.");
          askForId();
        }
      }).catch((error) => {
        console.error("Error fetching ID:", error);
      });
    } else {
      askForId();
    }
  }   

  askForId();
};           

  flatpickr("#modDate", { dateFormat: "d-m-Y" });

  function updateTotals() {
  const table = document.getElementById("myTable");
  const rows = table.querySelectorAll("tbody tr");

  let daySum = 0;
  let nightSum = 0;

  rows.forEach(row => {
    if (row.id === "totalsRow") return;

    // Skip rows that are hidden by filtering
    if (row.style.display === "none") return;

    const cells = row.querySelectorAll("td");
    const dayVal = parseInt(cells[5].textContent.replace(/,/g, "")) || 0;
    const nightVal = parseInt(cells[6].textContent.replace(/,/g, "")) || 0;

    daySum += dayVal;
    nightSum += nightVal;
  });

  document.getElementById("dayTotal").textContent = daySum.toLocaleString();
  document.getElementById("nightTotal").textContent = nightSum.toLocaleString();
  document.getElementById("grandTotal").textContent = (parseInt(daySum) + parseInt(nightSum)).toLocaleString();
}   
////
const separated = () => {
  const rows = document.querySelectorAll("#myTable tbody tr");

  rows.forEach(row => {
    const td6 = row.querySelector("td:nth-child(6)");
    const td7 = row.querySelector("td:nth-child(7)");

    if (td6) {
      const num6 = parseFloat(td6.textContent.replace(/,/g, ''));
      if (!isNaN(num6)) {
        td6.textContent = num6.toLocaleString();
      }
    }

    if (td7) {
      const num7 = parseFloat(td7.textContent.replace(/,/g, ''));
      if (!isNaN(num7)) {
        td7.textContent = num7.toLocaleString();
      }
    }
  });
}

////
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));


</script>

</body>
</html>
